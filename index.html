<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Oil Price Prediction UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0a0e1a;
        --card: #0f1419;
        --card-hover: #141923;
        --muted: #8b92a8;
        --text: #e8eaed;
        --primary: #00d9a3;
        --primary-dark: #00b386;
        --accent: #00b4ff;
        --accent-dark: #0095d9;
        --warn: #ffb800;
        --danger: #ff4757;
        --border: #1a1f2e;
        --shadow: rgba(0, 217, 163, 0.1);
        --glow: rgba(0, 217, 163, 0.15);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(135deg, #0a0e1a 0%, #121620 100%);
        color: var(--text);
        font: 14px/1.6 "Inter", system-ui, Segoe UI, Roboto, Helvetica, Arial;
        min-height: 100vh;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(0, 217, 163, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(0, 180, 255, 0.03) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }
      .wrap {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 24px;
        position: relative;
        z-index: 1;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      .cols {
        grid-template-columns: repeat(12, 1fr);
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--primary),
          transparent
        );
        opacity: 0;
        transition: opacity 0.3s;
      }
      .card:hover::before {
        opacity: 0.5;
      }
      .card:hover {
        border-color: rgba(0, 217, 163, 0.3);
        box-shadow: 0 8px 32px var(--shadow);
        transform: translateY(-2px);
      }
      h1 {
        font-size: 32px;
        margin: 0 0 12px;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      h2 {
        font-size: 18px;
        margin: 0 0 16px;
        color: var(--text);
        font-weight: 700;
        letter-spacing: -0.02em;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text);
        font-weight: 600;
        font-size: 13px;
        letter-spacing: 0.01em;
      }
      select,
      input,
      textarea {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(10, 14, 26, 0.8);
        color: var(--text);
        transition: all 0.2s;
        font-size: 14px;
      }
      select:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--glow);
      }
      select:hover,
      input:hover,
      textarea:hover {
        border-color: rgba(0, 217, 163, 0.5);
      }
      textarea {
        min-height: 72px;
        resize: vertical;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn {
        cursor: pointer;
        border: 1px solid var(--border);
        background: rgba(10, 14, 26, 0.8);
        color: var(--text);
        padding: 12px 20px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }
      .btn:hover::before {
        width: 300px;
        height: 300px;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .btn.primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        border-color: transparent;
        color: #0a1612;
        box-shadow: 0 4px 12px var(--shadow);
      }
      .btn.primary:hover {
        box-shadow: 0 6px 20px var(--glow);
        transform: translateY(-2px);
      }
      .btn.accent {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent-dark) 100%
        );
        border-color: transparent;
        color: #0a1419;
        box-shadow: 0 4px 12px rgba(0, 180, 255, 0.1);
      }
      .btn.accent:hover {
        box-shadow: 0 6px 20px rgba(0, 180, 255, 0.2);
        transform: translateY(-2px);
      }
      .btn.ghost {
        background: rgba(10, 14, 26, 0.8);
        border-color: var(--border);
      }
      .btn.ghost:hover {
        background: var(--card-hover);
        border-color: var(--muted);
      }
      .btn.warn {
        background: linear-gradient(135deg, var(--warn) 0%, #e5a600 100%);
        border-color: transparent;
        color: #2d1f00;
        box-shadow: 0 4px 12px rgba(255, 184, 0, 0.1);
      }
      .btn.warn:hover {
        box-shadow: 0 6px 20px rgba(255, 184, 0, 0.2);
        transform: translateY(-2px);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(0, 217, 163, 0.1);
        border: 1px solid rgba(0, 217, 163, 0.2);
        gap: 8px;
        font-size: 13px;
        transition: all 0.2s;
      }
      .pill:hover {
        background: rgba(0, 217, 163, 0.15);
        border-color: rgba(0, 217, 163, 0.3);
      }
      .pill code {
        color: var(--primary);
        font-family: "Consolas", "Monaco", monospace;
        font-weight: 600;
      }
      .status {
        font-size: 12px;
        color: var(--muted);
      }
      pre {
        background: rgba(10, 14, 26, 0.8);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        overflow: auto;
        max-height: 400px;
        font-size: 13px;
        line-height: 1.6;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
      }
      th,
      td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }
      th {
        color: var(--primary);
        font-weight: 700;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: rgba(0, 217, 163, 0.05);
      }
      td strong {
        color: var(--primary);
        font-size: 16px;
      }
      tr:hover {
        background: rgba(0, 217, 163, 0.03);
      }
      .kpi {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 16px 0;
        padding: 0;
      }
      .kpi .card {
        padding: 16px;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: rgba(0, 217, 163, 0.05);
        border: 1px solid rgba(0, 217, 163, 0.15);
        border-radius: 12px;
        margin: 0;
        transition: all 0.3s;
      }
      .kpi .card:hover {
        background: rgba(0, 217, 163, 0.1);
        border-color: rgba(0, 217, 163, 0.3);
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 24px var(--glow);
      }
      .kpi .v {
        font-size: 24px;
        font-weight: 800;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-top: 4px;
      }
      .kpi #k_model {
        font-size: 12px !important;
        line-height: 1.3;
        font-weight: 700;
      }
      .muted {
        color: var(--muted);
      }
      .ok {
        color: var(--primary);
      }
      .bad {
        color: var(--danger);
      }
      .footer {
        margin-top: 18px;
        color: var(--muted);
        font-size: 12px;
      }

      /* Responsive design for balanced layout */
      @media (max-width: 1200px) {
        .grid.cols[style*="grid-template-columns: repeat(12, 1fr)"] {
          grid-template-columns: 1fr;
        }
        .grid.cols[style*="grid-template-columns: repeat(12, 1fr)"]
          .card[style*="grid-column: span 7"] {
          grid-column: span 1;
        }
        .grid.cols[style*="grid-template-columns: repeat(12, 1fr)"]
          .card[style*="grid-column: span 5"] {
          grid-column: span 1;
        }
      }

      @media (max-width: 768px) {
        .grid[style*="grid-template-columns: 1fr 1fr"] {
          grid-template-columns: 1fr;
        }
        .grid[style*="grid-template-columns: 1fr 1fr"] {
          gap: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap grid">
      <div class="card">
        <h1>Oil Price Prediction UI</h1>
        <div class="row">
          <span class="pill"
            >API <code id="apiBasePill">http://127.0.0.1:8000</code></span
          >
          <span class="pill status" id="status">Checking...</span>
        </div>
      </div>

      <div class="grid cols" style="grid-template-columns: repeat(12, 1fr)">
        <div class="card" style="grid-column: span 7">
          <h2>Inputs</h2>

          <!-- Country and Item Selection -->
          <div
            class="grid"
            style="
              grid-template-columns: 1fr 1fr;
              gap: 16px;
              margin-bottom: 16px;
            "
          >
            <div>
              <label>Country</label>
              <select id="country"></select>
            </div>
            <div>
              <label>Item (Oil type)</label>
              <select id="item"></select>
            </div>
          </div>

          <!-- Historical Prices Input -->
          <div style="margin-bottom: 16px">
            <label
              >Historical prices (most recent first, comma-separated)</label
            >
            <textarea
              id="prices"
              placeholder="e.g. 42.5, 42.1, 41.8, 41.5, 41.3, 41.0"
              style="width: 100%; min-height: 80px; resize: vertical"
            ></textarea>
            <div class="muted" style="margin-top: 6px">
              Tip: ใส่ได้ 1–12 ค่า ล่าสุดอยู่หน้าสุด ระบบจะคำนวณ lag/rolling
              ให้อัตโนมัติ
            </div>
          </div>

          <!-- Action Buttons -->
          <div
            class="grid"
            style="
              grid-template-columns: 1fr 1fr;
              gap: 12px;
              margin-bottom: 12px;
            "
          >
            <button class="btn primary" id="btnPredict">
              🔮 Predict (next month)
            </button>
            <button class="btn accent" id="btnForecast">
              📈 Forecast (multi-month)
            </button>
          </div>

          <!-- Month Input and Clear -->
          <div class="row" style="gap: 12px; align-items: center">
            <div style="display: flex; align-items: center; gap: 8px">
              <label for="months" style="margin: 0; font-size: 14px"
                >Months:</label
              >
              <input
                type="number"
                id="months"
                value="6"
                min="1"
                max="12"
                style="
                  width: 80px;
                  padding: 8px 12px;
                  border-radius: 6px;
                  border: 1px solid var(--border);
                  background: var(--bg);
                  color: var(--text);
                "
              />
            </div>
            <button class="btn ghost" id="btnClear">Clear</button>
          </div>
        </div>

        <div
          class="card"
          style="
            grid-column: span 5;
            position: relative;
            border: 2px solid var(--primary);
          "
        >
          <h2>Model Info</h2>
          <div class="row">
            <button class="btn warn" id="btnModelInfo">
              ℹ️ Load /model-info
            </button>
            <button class="btn ghost" id="btnRoot">Root</button>
          </div>
          <div id="kpi" class="kpi">
            <div class="card">
              <div class="muted">Model</div>
              <div
                class="v"
                id="k_model"
                style="font-size: 12px; line-height: 1.3; word-wrap: break-word"
              >
                CatBoost
              </div>
            </div>
            <div class="card">
              <div class="muted">Features</div>
              <div
                class="v"
                id="k_feats"
                style="font-size: 12px; line-height: 1.3"
              >
                36
              </div>
            </div>
          </div>
          <div class="footer">* ใช้ข้อมูลจาก API ของคุณแบบเรียลไทม์</div>
        </div>
      </div>

      <div class="card">
        <h2>Results</h2>
        <div id="outTable"></div>
        <pre id="outJson" style="margin-top: 12px; display: none"></pre>
      </div>

      <div class="card" style="display: none">
        <h2>Raw API Response</h2>
        <pre id="debug"></pre>
      </div>
    </div>

    <script>
      // ==== CONFIG ====
      const API_BASE = "/api";
      document.getElementById("apiBasePill").textContent =
        location.origin + API_BASE;

      // ==== DOM ====
      const els = {
        country: document.getElementById("country"),
        item: document.getElementById("item"),
        prices: document.getElementById("prices"),
        months: document.getElementById("months"),
        btnPredict: document.getElementById("btnPredict"),
        btnForecast: document.getElementById("btnForecast"),
        btnClear: document.getElementById("btnClear"),
        btnModelInfo: document.getElementById("btnModelInfo"),
        btnRoot: document.getElementById("btnRoot"),
        status: document.getElementById("status"),
        outJson: document.getElementById("outJson"),
        outTable: document.getElementById("outTable"),
        debug: document.getElementById("debug"),
        kpi: document.getElementById("kpi"),
        k_model: document.getElementById("k_model"),
        k_feats: document.getElementById("k_feats"),
      };

      // ==== Helpers ====
      const $ = (sel) => document.querySelector(sel);

      function parsePrices(text) {
        const arr = text
          .split(/,|\s+/)
          .map((s) => s.trim())
          .filter(Boolean)
          .map(Number);
        if (!arr.length || arr.some(isNaN))
          throw new Error(
            "กรุณาใส่ราคาตัวเลขคั่นด้วย comma เช่น 42.5, 42.1, 41.8"
          );
        if (arr.length > 12) throw new Error("ใส่ได้สูงสุด 12 ค่า");
        return arr;
      }

      function setLoading(loading) {
        [
          els.btnPredict,
          els.btnForecast,
          els.btnModelInfo,
          els.btnRoot,
        ].forEach((b) => (b.disabled = loading));
        els.status.textContent = loading ? "Loading…" : "Ready";
      }

      function showDebug(obj) {
        els.debug.textContent =
          typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      }

      function showJson(obj) {
        els.outJson.style.display = "none";
        els.outJson.textContent = JSON.stringify(obj, null, 2);
      }

      function clearOutput() {
        els.outTable.innerHTML = "";
        els.outJson.textContent = "";
        els.debug.textContent = "";
      }

      function table(html) {
        return `<div style="overflow:auto"><table>${html}</table></div>`;
      }

      function renderPredict(res) {
        const rows = `
      <tr><th>Country</th><td>${res.country}</td></tr>
      <tr><th>Item</th><td>${res.item}</td></tr>
      <tr><th>Predicted Price (Baht)</th><td><strong>${Number(
        res.predicted_price_baht
      ).toFixed(2)}</strong></td></tr>
      <tr><th>Historical Prices Used</th><td>${
        res.historical_prices_used
      }</td></tr>
    `;
        els.outTable.innerHTML = table(rows);
      }

      function renderForecast(res) {
        const header = `<tr><th>#</th><th>Month Ahead</th><th>Predicted Price (Baht)</th></tr>`;
        const body = (res.forecast_results?.monthly_forecasts || [])
          .map(
            (m, i) =>
              `<tr><td>${i + 1}</td><td>${m.month}</td><td><strong>${Number(
                m.predicted_price_baht
              ).toFixed(2)}</strong></td></tr>`
          )
          .join("");
        const sum = res.summary || {};
        const summary = `
      <tr><th>Average</th><td colspan="2">${Number(
        sum.average_price ?? 0
      ).toFixed(2)}</td></tr>
      <tr><th>Trend</th><td colspan="2">${sum.trend ?? "-"}</td></tr>
      <tr><th>Volatility (σ)</th><td colspan="2">${Number(
        sum.volatility ?? 0
      ).toFixed(2)}</td></tr>
      <tr><th>Total Change (฿)</th><td colspan="2">${Number(
        sum.total_change_baht ?? 0
      ).toFixed(2)} (${Number(sum.total_change_percent ?? 0).toFixed(
          2
        )}%)</td></tr>
      <tr><th>Range</th><td colspan="2">${Number(
        sum.price_range?.min ?? 0
      ).toFixed(2)} – ${Number(sum.price_range?.max ?? 0).toFixed(
          2
        )} (Δ=${Number(sum.price_range?.range ?? 0).toFixed(2)})</td></tr>
    `;
        els.outTable.innerHTML = `
      ${table(header + body)}
      <div style="height:10px"></div>
      ${table(summary)}
    `;
      }

      function updateKpiFromRoot(root) {
        if (!root?.model_performance) return;
        els.kpi.style.display = "flex";
        els.kpi.style.flexDirection = "column";
        els.k_model.textContent = "CatBoost";
        els.k_feats.textContent = root.feature_count || "36";
        console.log("Root feature_count:", root.feature_count);
      }

      function updateKpiFromModelInfo(info) {
        els.kpi.style.display = "flex";
        els.kpi.style.flexDirection = "column";
        const testPerf = info.performance_metrics?.test || {};
        els.k_model.textContent = info.model_type || "CatBoost";
        els.k_feats.textContent = info.feature_count || "36";
        console.log("ModelInfo feature_count:", info.feature_count);
      }

      async function api(path, options = {}) {
        const url = `${API_BASE}${path}`;
        const res = await fetch(url, options);
        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = text;
        }
        showDebug({ status: res.status, path, data });
        if (!res.ok)
          throw new Error(
            typeof data === "string"
              ? data
              : data.detail || data.message || "Request failed"
          );
        return data;
      }

      // ==== Actions ====
      async function boot() {
        setLoading(true);
        try {
          const root = await api("/");
          els.status.textContent = `OK • countries: ${
            root.available_countries || 0
          }, items: ${root.available_items || 0}`;
          updateKpiFromRoot(root);

          const countries = (await api("/countries")).countries || [];
          els.country.innerHTML = countries
            .map((c) => `<option value="${c}">${c}</option>`)
            .join("");

          const items = (await api("/items")).items || [];
          els.item.innerHTML = items
            .map((i) => `<option value="${i}">${i}</option>`)
            .join("");
        } catch (err) {
          els.status.textContent = `Error: ${err.message}`;
          console.error(err);
          els.kpi.style.display = "flex";
          els.kpi.style.flexDirection = "column";
          els.k_model.textContent = "CatBoost";
          els.k_feats.textContent = "36";
        } finally {
          setLoading(false);
        }
      }

      async function onPredict() {
        clearOutput();
        setLoading(true);
        try {
          const payload = {
            country: els.country.value,
            item: els.item.value,
            historical_prices: parsePrices(els.prices.value),
          };
          const res = await api("/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          renderPredict(res);
          showJson(res);
        } catch (err) {
          alert(err.message);
        } finally {
          setLoading(false);
        }
      }

      async function onForecast() {
        clearOutput();
        setLoading(true);
        try {
          const payload = {
            country: els.country.value,
            item: els.item.value,
            historical_prices: parsePrices(els.prices.value),
            months_ahead: Math.max(
              1,
              Math.min(12, Number(els.months.value) || 1)
            ),
          };
          const res = await api("/forecast", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          renderForecast(res);
          showJson(res);
        } catch (err) {
          alert(err.message);
        } finally {
          setLoading(false);
        }
      }

      async function onModelInfo() {
        setLoading(true);
        try {
          const info = await api("/model-info");
          updateKpiFromModelInfo(info);
          showJson(info);
        } catch (err) {
          alert(err.message);
        } finally {
          setLoading(false);
        }
      }

      async function onRoot() {
        setLoading(true);
        try {
          const root = await api("/");
          updateKpiFromRoot(root);
          showJson(root);
        } catch (err) {
          alert(err.message);
        } finally {
          setLoading(false);
        }
      }

      // ==== Bindings ====
      els.btnPredict.addEventListener("click", onPredict);
      els.btnForecast.addEventListener("click", onForecast);
      els.btnModelInfo.addEventListener("click", onModelInfo);
      els.btnRoot.addEventListener("click", onRoot);
      els.btnClear.addEventListener("click", clearOutput);

      // ==== Init ====
      boot();
    </script>
  </body>
</html>
